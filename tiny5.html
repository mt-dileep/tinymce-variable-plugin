<!DOCTYPE html>
<html>
  <head>
    <!-- <script
      type="text/javascript"
      src="https://assets.mindtickle.com/selfserve/prod/bower_components/tinymce/tinymce.min.586ce1e0.js"
    ></script> -->
    <script
      src="https://cdn.tiny.cloud/1/4eipi8mfr092w22jp2qz0jnl1ljmu8k29ku9e04g4x93xaqz/tinymce/5/tinymce.min.js"
      referrerpolicy="origin"
    ></script>
    <script type="text/javascript" src="plugin.js"></script>
    <script type="text/javascript">
      window.loadTemplateAndInitTinyMce = function () {
        var REGEX = {
          EJS_OP_VAR: "[\\s\\t\\n]*[a-zA-Z.0-9[\\]]*[\\s\\t\\n]*",
          DOLLOR_VAR: "([^$]*)?",
          EJS_NO_OP_VAR: "[^=]([^%][^>]*)?"
        };
        var variableMapper = {};
        function addToVariableMap(variable, readable) {
          variableMapper[variable] = readable;
        }
        var variablesMenu = [];
        function addInVarMenu(menuItem) {
          var exist = false;
          variablesMenu.some(function (item) {
            if (item.text == menuItem.text) {
              exist = true;
              return;
            }
          });
          if (!exist) variablesMenu.push(menuItem);
        }

        tinymce.init({
          // basic tinyMCE stuff
          content_css: "style.css",
          selector: "textarea",
          menubar: false,
          toolbar:
            "code variables | bold italic underline | bullist numlist outdent indent",
          statusbar: false,
          table_advtab: false,
          table_row_advtab: false,
          table_cell_advtab: false,
          table_default_styles: {
            border: 0,
            background: "none"
          },
          // variable plugin related
          plugins: "variables code lists",
          variable_mapper: variableMapper,
          variable_prefix: "<%=",
          variable_suffix: "%>",
          extra_variable_ps: [
            {
              prefix: "<%",
              suffix: "%>",
              regex: REGEX.EJS_NO_OP_VAR
            },
            {
              prefix: "$",
              suffix: "$",
              regex: REGEX.DOLLOR_VAR
            }
          ],
          height: 1000, //TODO 740

          //setup
          setup: function (editor) {
            window.tester = editor;
            var content = document.querySelector("textarea").value;
            var matchesEjsVar = content.match(
              new RegExp("<%=" + REGEX.EJS_OP_VAR + "%>", "g")
            );
            if (matchesEjsVar) {
              matchesEjsVar.forEach(function (match) {
                //slice after "<%=".length to minus "%>".length
                var newVar = match.slice(3, match.length - 2);
                addToVariableMap(newVar, newVar.toUpperCase());
                addInVarMenu({ text: newVar + " (scoped)", value: match }); //TODO comment
              });
            }

            var matchesDollarVars = content.match(
              new RegExp("\\$" + REGEX.DOLLOR_VAR + "\\$", "g")
            );
            if (matchesDollarVars) {
              matchesDollarVars.forEach(function (match) {
                // trim $ from start and end
                var newVar = match.slice(1, match.length - 1);
                addToVariableMap(
                  newVar,
                  newVar.replaceAll("_", " ").toUpperCase()
                );
                addInVarMenu({ text: newVar + " (global)", value: match });
              });
            }

            console.log(variableMapper);
            editor.ui.registry.addMenuButton("variables", {
              text: "Variables",
              tooltip: "Add variables in Template",
              fetch: (callback) => {
                editor.notificationManager.open({
                  type: "info",
                  text:
                    "Scoped Variables must be used inside two 'EJS code' blocks where it is already being used. Global can be used anywhere in the template.",
                  closeButton: true
                });
                var items = variablesMenu.map((v) => {
                  return {
                    type: "menuitem",
                    text: v.text,
                    onAction: () => {
                      // Insert content at the location of the cursor.
                      editor.insertContent(v.value);
                      // editor.notificationManager.close(); //TODO
                    }
                  };
                });
                callback(items);
              }
            });

            editor.on("variableClick", function (e) {
              // console.log("click", e);
              alert("This field is non-editable!");
            });
            // editor.on("init", function () {
            //   console.log("inti..............");

            //   var content = document.getElementById("templateContent").value;
            //   content = content.replace(/alt="[^"]*"/g, (match) => {
            //     console.log("alt->", match[5]);
            //     return match[5] == "$"
            //       ? match.splice(5, 1)
            //       : match.splice(5, 4);
            //   });
            //   editor.setContent(content);
            // });
          }
          // variable_class: 'bbbx-my-variable',
          //variable_valid: ['username', 'sender', 'phone', 'community_name', 'email']
          // test block  ------------------------------------------------------
          // init_instance_callback: function (editor) {
          //   console.log("Editor: " + editor.id + " is now initialized.");
          // }
        });
      };
      var urlParams = new URLSearchParams(window.location.search);
      var templateToLoad = urlParams.get("template");
      if (!templateToLoad) templateToLoad = "_learner_series_invitation";
      fetch("./default_templates/" + templateToLoad + ".json")
        .then((response) => response.json())
        .then(function (template) {
          document.getElementById("templateContent").value = template.body;
          loadTemplateAndInitTinyMce();
        });
    </script>
    <style type="text/css">
      .variable {
        cursor: default;
        background-color: #65b9dd;
        color: #fff;
        padding: 2px 8px;
        border-radius: 3px;
        font-weight: bold;
        font-style: normal;
        font-size: 10px;
        display: inline-block;
        line-height: 12px;
      }
    </style>
  </head>
  <body>
    <form method="post">
      <textarea rows="18" id="templateContent"></textarea>
    </form>
  </body>
</html>
